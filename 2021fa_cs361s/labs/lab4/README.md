# Lab4: TLS Interception and Visibility

|||
|---|---|
| Assigned | 2021-10-13|
| Due: | 2021-10-27 |
| Points | 100 |

## SECURITY DISCLAIMER

In this lab, you will do many things that are BAD, BAD, BAD.
We will be setting up some simplified
security and some weak security that SHOULD NEVER BE USED. 

Here is a list of every bad decision we're making
with respect to security:

1. We are installing a trusted CA into a Firefox browser
profile. This would be a very dangerous thing to do and
you should PROTECT THE PRIVATE KEY CAREFULLY
1. We are going to disable TLS 1.3 in our Firefox Profile
1. We are going to disable OCSP stapling in our Firefox Profile\
1. We are going to enable a deprecated cipher (TLS_DHE_RSA_WITH_AES_128_CBC_SHA)

I STRONGLY RECOMMEND THAT, AFTER THE LAB IS OVER, YOU DELETE THE
FIREFOX PROFILE, OR AT LEAST RENDER IT INOPERABLE.

## Overview

In Lab 3, you implemented TLS (on the server side). TLS provides *end-to-end* encryption.
That means it is completely protected from the browser to the server. It *should* be
invulnerable to Man-In-The-Middle (MITM) attacks. That means that even if a computer
intercepts all messages it should not be able to read them or undetectably alter them.

In this lab, you are going to *break* TLS and insert an MITM that *can* read the data.
It will do this by getting Firefox to accept a "root" certificate that you create.

## Step One:  Creating a Certificate

You can create a new CA (Certificate Authority) cert for this lab or you can use the
same one from lab 3. You should use the one you labelled "CA". Make sure you have the
associated private key.

You do NOT need to have the host certificate (the one that had "cs361s.utexas.lab2" as
the common name). Instead, your source code will *generate* a certificate on the fly
for *every* web site that it needs to intercept.

The source code for this project is pretty minimal. There is one single
function in `server.py` that you need to fill in:

    def generate_proxy_crypto(self, host):
    
In this method, you need to use the Cryptography module to generate
a certificate (and private key) specifically for the host requested. 
You can find an example of 90 percent of what you need to do on this
[Cryptography documentation page](https://cryptography.io/en/latest/x509/reference/#x-509-certificate-builder).

Please note that the Cryptography example creates a self-signed certificate
where the SUBJECT and ISSUER are the same. Your certificate needs to have
the issuer be the issuer of the CA certificate you created using OpenSSL.
That will already be in this class as `self.root_cert`. You will also notice
that in the Cryptography example you sign the certificate using the generated
private key (hence, "self-signed"). You also need to change that. Your 
certificate needs to be signed by the CA key you created with OpenSSL. That
will already be in this class as `self.root_key`.

At the end of the method, you will return the tuple `(host_cert, host_key)`.
This is the certificate and corresponding private key you generated for this
host.


## Step Two: Getting HTTPS Proxy working in Firefox

I want you to use Firefox for this assignment because Firefox allows
you to install certificates into a profile. As far as I can tell, Chrome
and Microsoft browsers only install certificates globally for the computer.
I DO NOT WANT YOU TO INSTALL ANY GLOBAL CERTIFICATES. IT IS A HUGE
SECURITY RISK.

So, to do this part of the lab, you need to install Firefox and create
a separate profile. This is not a sign-in, so no need to have a new
login and password. Rather, look up the Firefox documentation for 
profile management and learn how to create a separate profile. Name
the profile something about "Dangerous" or "Experimental" or "testing only".

Once you have created the profile, and launched it, you can make changes
to this profile that will not affect the system or even other Firefox profiles.

Here are the changes you need to make.

First, go into settings and find the option to add trusted certificates.
You need to install the CA certificate from setp one. This is the certificate
generated by OpenSSL. Not a certificate dynamically generated by your code.

Now, go to a URL bar and type `about:config` to bring up the advanced
config panel. Change the following settings:

1. security.ssl.enable_ocsp_must_staple to false
1. security.ssl.enable_ocsp_stapling to false
1. security.ssl3.dhe_rsa_aes_128_sha to true
1. security.tls.version.fallback-limit to 3
1. security.tls.version.max to 3

Now, once you have all of these settings in place, you need to go to
Firefox's network settings and find the Proxy settings. In this window,
set both the HTTP proxy and HTTPS proxy to your local computer
(`127.0.0.1`) and the port to whatever port number you plan to use.

You will now run your `tls_frontend` but in `https-proxy` mode instead of `proxy`.

    python3 -m tls_frontend.server https-proxy 9999 <CA cert filename> <CA private key filename>
    
You can now browse to anywebsite using Firefox and your tls_frontend will intercept and decrypt
the data.

## Grading and Submission

The submission for the lab will be on Canvas. Zip your tls_frontend folder and upload on the link.

For 100% credit, the entire lab4 should be working correctly, along with the Firefox demo. This would only be possible if your lab3 code is working correctly.

For 80% credit, if Firefox demo is not working correctly, but the code for the generate_proxy_crypto is complete, I will evaluate your grade based on that. I will be lenient in this evaluation and you do not need to get every line correct, since if your lab3 is not set up correctly, then it would be difficult to evaluate your code for lab4.


